---
title: 'Analyzing bbcnews text'
Author: Ziyi
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: true
    code_folding: hide
---

### Step 0: Data Cleaning
*create the corpus*
```{r set up}
# load the packages
library(tm)
library(dplyr)
library(tidytext)
library(kernlab)

busi_location <- "../data/bbc/business/"
entertain_location <- "../data/bbc/entertainment/"
politics_location <- "../data/bbc/politics/"
sport_location <- "../data/bbc/sport/"
tech_location <- "../data/bbc/tech/"

source("../lib/functions.R")
```

```{r read_text}
read_txt <- function(file_name, file_loca){
  current_file_name <- sub(".txt","",file_name)
  current_ground_truth <- readLines(paste(file_loca,current_file_name,".txt",sep=""), encoding="UTF-8",warn=FALSE)
  return(current_ground_truth)
}

busi_bigr_lib <- busi_location %>% list.files() %>% lapply(., read_txt,busi_location)
entertain_bigr_lib <- entertain_location %>% list.files() %>%
  lapply(., read_txt,entertain_location)
politics_bigr_lib <- politics_location %>%list.files() %>% 
  lapply(., read_txt,politics_location)
sport_bigr_lib <- sport_location %>% list.files() %>% lapply(., read_txt, sport_location)
tech_bigr_lib <- tech_location %>% list.files() %>% lapply(., read_txt, tech_location)
```

```{r stop words}
data("stop_words")
word <- c("bn","ago","yesterday","lot","today","months","month",
                 "happier","happiest","last","week","past")
#add words in the stop_words and the level of lexicon is 'updated
stop_words <- stop_words %>% bind_rows(mutate(tibble(word), lexicon = "updated")) 
```

### Step 1: Heatmap
```{r corpus}
busi_corpus <- dictionary(busi_bigr_lib)
entertain_corpus <- dictionary(entertain_bigr_lib)
politics_corpus <- dictionary(politics_bigr_lib)
sport_corpus <- dictionary(sport_bigr_lib)
tech_corpus <- dictionary(tech_bigr_lib)

busi_biletter <- busi_corpus %>% biletter_list() %>% into_dataframe() # 600770 3
politics_biletter <- politics_corpus %>% biletter_list() %>% into_dataframe() #628390 3
entertain_biletter <- entertain_corpus %>% biletter_list() %>% into_dataframe() #431247 3
tech_biletter <- tech_corpus %>% biletter_list() %>% into_dataframe() # 673618 3
sport_biletter <- sport_corpus %>% biletter_list() %>% into_dataframe() # 529903 3
```

```{r biletter csv}

#write.csv(busi_biletter, file = "../output/busi_biletter.csv", row.names = F)
#write.csv(politics_biletter, file = "../output/politics_biletter.csv",row.names = F)
#write.csv(entertain_biletter, file = "../output/entertain_biletter.csv",row.names = F)
#write.csv(tech_biletter, file = "../output/tech_biletter.csv",row.names = F)
#write.csv(sport_biletter, file = "../output/sport_biletter.csv",row.names = F)

```

```{r}
# Business
busi_df <- busi_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) 

busi_density <- unite(busi_df, letters, c(X1, X2), remove=T, sep = "") 
busi_density$freq <- (busi_density$n+1)/sum(busi_density$n)
all_letters <- busi_density[,1]


busi_df %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Business News")
```
```{r}
# Politics
politics_df <- politics_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) 

politics_density <- unite(politics_df, letters, c(X1, X2), remove=T, sep = "") 
politics_density$freq <- (politics_density$n+1)/sum(politics_density$n)


politics_df%>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Politics News")
```


```{r}
# Entertainment
entertain_df <- entertain_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) 

entertain_density <- unite(entertain_df, letters, c(X1, X2), remove=T, sep = "") 
entertain_density$freq <- (entertain_density$n+1)/sum(entertain_density$n)

entertain_df %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Entertainment News")
```
```{r}
# Sport
sport_df <- sport_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) 

sport_density <- unite(sport_df, letters, c(X1, X2), remove=T, sep = "") 
sport_density$freq <- (sport_density$n+1)/sum(sport_density$n)


sport_df %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Sport News")
```

```{r}
# Technology
tech_df <- tech_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) 

tech_density <- unite(tech_df, letters, c(X1, X2), remove=T, sep = "") 
tech_density$freq <- (tech_density$n+1)/sum(tech_density$n)

tech_df %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Technology News")
```


### Step 2: SVM 
```{r features}

busi_feat <- extract.features(busi_bigr_lib,1)
sport_feat <- extract.features(sport_bigr_lib,2)
entertain_feat <- extract.features(entertain_bigr_lib,3)
politics_feat <- extract.features(politics_bigr_lib,4)
tech_feat <- extract.features(tech_bigr_lib,5)

```

```{r train set}
# 70% data as train set
set.seed(0)
busi_ind <- train.ind(busi_bigr_lib)
politics_ind <- train.ind(politics_bigr_lib)
entertain_ind <- train.ind(entertain_bigr_lib)
sport_ind <- train.ind(sport_bigr_lib)
tech_ind <- train.ind(tech_bigr_lib)

train_feat <- list(features = rbind(busi_feat$features[busi_ind,],
                      politics_feat$features[politics_ind,],
                      entertain_feat$features[entertain_ind,],
                      sport_feat$features[sport_ind,],
                      tech_feat$features[tech_ind,]), 
                   labels = c(busi_feat$labels[busi_ind], 
                              politics_feat$labels[politics_ind],
                              entertain_feat$labels[entertain_ind],
                              sport_feat$labels[sport_ind],
                              tech_feat$labels[tech_ind]))

test_feat <- list(features = rbind(busi_feat$features[-busi_ind,],
                      politics_feat$features[-politics_ind,],
                      entertain_feat$features[-entertain_ind,],
                      sport_feat$features[-sport_ind,],
                      tech_feat$features[-tech_ind,]), 
                   labels = c(busi_feat$labels[-busi_ind], 
                              politics_feat$labels[-politics_ind],
                              entertain_feat$labels[-entertain_ind],
                              sport_feat$labels[-sport_ind],
                              tech_feat$labels[-tech_ind]))

# save(train_feat, file = "../output/train_feat.RData")
# save(test_feat, file = "../output/test_feat.RData")
```

```{r}
fit_svm <- ksvm(train_feat$features, as.factor(train_feat$labels), type = "C-svc", kernel = "rbfdot")
test_pred <- predict(fit_svm, test_feat$features)
test_error <- sum(test_pred != test_feat$labels)/sum(test_feat$labels)
cat("train error:",fit_svm@error, "\n","test error:", test_error)
```

### Step 3: New file
```{r}

```

