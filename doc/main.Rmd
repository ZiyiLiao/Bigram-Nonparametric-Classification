---
title: 'Analyzing bbcnews text'
Author: Ziyi
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: true
    code_folding: hide
---

### Step 0: Data Cleaning
*create the corpus*
```{r set up}
# load the packages
library(tm)
library(dplyr)
library(tidytext)

busi_location <- "../data/bbc/business/"
entertain_location <- "../data/bbc/entertainment/"
politics_location <- "../data/bbc/politics/"
sport_location <- "../data/bbc/sport/"
tech_location <- "../data/bbc/tech/"
```

```{r read_text}
read_txt <- function(file_name, file_loca){
  current_file_name <- sub(".txt","",file_name)
  current_ground_truth <- readLines(paste(file_loca,current_file_name,".txt",sep=""), encoding="UTF-8",warn=FALSE)
  return(current_ground_truth)
}

busi_bigr_lib <- busi_location %>% list.files() %>% lapply(., read_txt,busi_location)
entertain_bigr_lib <- entertain_location %>% list.files() %>% lapply(., read_txt,entertain_location)
politics_bigr_lib <- politics_location %>%list.files() %>% lapply(., read_txt,politics_location)
sport_bigr_lib <- sport_location %>% list.files() %>% lapply(., read_txt, sport_location)
tech_bigr_lib <- tech_location %>% list.files() %>% lapply(., read_txt, tech_location)
```

```{r stop words}
data("stop_words")
word <- c("bn","ago","yesterday","lot","today","months","month",
                 "happier","happiest","last","week","past")
#add words in the stop_words and the level of lexicon is 'updated
stop_words <- stop_words %>% bind_rows(mutate(tibble(word), lexicon = "updated")) 
```

```{r}
dictionary <- function(bigr_lib, path){
  corpus<- VCorpus(VectorSource(bigr_lib))%>%
    tm_map(content_transformer(tolower))%>%
    tm_map(removePunctuation)%>%
    tm_map(removeNumbers)%>%
    tm_map(removeWords, character(0))%>%
    tm_map(stripWhitespace)

  dict <- tidy(corpus) %>% select(text)  
  completed <- dict %>%
    mutate(id = list.files(path))  %>%
    unnest_tokens(dictionary, text) %>%
    anti_join(stop_words,by = c("dictionary" = "word")) 

  list <- completed$dictionary %>% paste(., collapse = " ")
  
  return(list)
}


busi_corpus <- dictionary(busi_bigr_lib, busi_location)
entertain_corpus <- dictionary(entertain_bigr_lib, entertain_location)
politics_corpus <- dictionary(politics_bigr_lib, politics_location)
sport_corpus <- dictionary(sport_bigr_lib, sport_location)
tech_corpus <- dictionary(tech_bigr_lib, tech_location)
```

### Step 1: Bi-letter
```{r biletter functions}
biletter <- function(token){
  ## Split into characterss:
  w <- strsplit(token, "")[[1]]
  ## Word tri-grams pasted together:
  return(vapply(ngrams(w, 2L), paste, "", collapse = ""))
}


biletter_list <- function(corpus){
  letter <- list()
  for(i in 1:length(corpus)){
    letter[[i]]<- corpus[i] %>% as.character() %>% biletter()
    }
  letter <- unlist(letter)
  return(letter)
}


into_dataframe <- function(list){
  df <- list %>% as.character() %>% strsplit(.,"") %>% unlist() %>% matrix(.,ncol = 2, byrow = T) %>% data.frame()
  df$biletter <- list
  return(df)
}
```
```{r biletter}
busi_biletter <- busi_corpus %>% biletter_list() %>% into_dataframe() # 600770 3
politics_biletter <- politics_corpus %>% biletter_list() %>% into_dataframe() #628390 3
entertain_biletter <- entertain_corpus %>% biletter_list() %>% into_dataframe() #431247 3
tech_biletter <- tech_corpus %>% biletter_list() %>% into_dataframe() # 673618 3
sport_biletter <- sport_corpus %>% biletter_list() %>% into_dataframe() # 529903 3
```
```{r biletter csv}

write.csv(busi_biletter, file = "../output/busi_biletter.csv", row.names = F)
write.csv(politics_biletter, file = "../output/politics_biletter.csv",row.names = F)
write.csv(entertain_biletter, file = "../output/entertain_biletter.csv",row.names = F)
write.csv(tech_biletter, file = "../output/tech_biletter.csv",row.names = F)
write.csv(sport_biletter, file = "../output/sport_biletter.csv",row.names = F)

```

### Step 3: Heatmap
*bi-letter*
```{r}
# Business
busi_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Business News")
```
```{r}
# Politics
politics_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Politics News")
```
```{r}
# Entertainment
entertain_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Entertainment News")
```
```{r}
# Sport
sport_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Sport News")
```

```{r}
# Technology
tech_biletter[,1:2] %>% 
  table()  %>% tbl_df() %>%
  mutate(X1 = factor(X1), X2 = factor(X2, levels = rev(unique(X2)))) %>%
  ggplot(., aes(x=X1, y=X2, fill=n)) +
  geom_tile() + theme_bw() + coord_equal() +
  scale_fill_distiller(palette="Greens", direction=1) +
  labs(x = "The First Letter", y = "The Second Letter", title = "Bi-letter from Technology News")
```

### Step 4: SVM
```{r}
library(kernlab)

busi_bigram <- read.csv("../output/busi_bigram.csv")
entertain_bigram <- read.csv("../output/entertain_bigram.csv")
politics_bigram <- read.csv("../output/politics_bigram.csv")
sport_bigram <- read.csv("../output/sport_bigram.csv")
tech_bigram <- read.csv("../output/tech_bigram.csv")

select.train <- function(df){
  n <- dim(df)[1]
  ind <- sample(1:n, floor(n*0.7), replace = F)
  return(df[ind,])
}

train <- ddply(data, .(label), select.train)
train_input <- train[,3] %>% as.vector()
train_labels <- train[,4] %>% as.vector()

fit_svm <- ksvm(train_input, as.factor(train_labels), type = "C-svc", kernel = "rbfdot")

```

